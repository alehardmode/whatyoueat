<!-- Vista simplificada del Historial de Paciente -->
<div class="container my-4">
  <!-- Cabecera -->
  <div class="row mb-3">
    <div class="col-12">
      <h1 class="border-bottom pb-2">Historial de <%= patient.name %></h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/doctor/dashboard">Dashboard</a>
          </li>
          <li class="breadcrumb-item active">Historial de Paciente</li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Datos del paciente -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row">
        <div class="col-md-9">
          <h5>Información del Paciente</h5>
          <p><strong>Nombre:</strong> <%= patient.name %></p>
          <p>
            <strong>Desde:</strong> <%=
            moment(patient.created_at).format('DD/MM/YYYY') %>
          </p>
        </div>
        <div class="col-md-3 text-end">
          <a href="/doctor/dashboard" class="btn btn-outline-primary">Volver</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <h5>Filtrar Entradas</h5>
      <form
        action="/doctor/patient/<%= patient.id %>/history"
        method="GET"
        class="row g-3"
      >
        <div class="col-md-4">
          <label for="date-from" class="form-label">Desde</label>
          <input
            type="date"
            class="form-control"
            id="date-from"
            name="date_from"
            value="<%= filters?.date_from || '' %>"
          />
        </div>
        <div class="col-md-4">
          <label for="date-to" class="form-label">Hasta</label>
          <input
            type="date"
            class="form-control"
            id="date-to"
            name="date_to"
            value="<%= filters?.date_to || '' %>"
          />
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2">Buscar</button>
          <a
            href="/doctor/patient/<%= patient.id %>/history"
            class="btn btn-outline-secondary"
            >Reiniciar</a
          >
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de entradas -->
  <div class="row">
    <% if (entries && entries.length > 0) { %> <% entries.forEach(entry => { %>
    <div class="col-md-6 col-lg-4 mb-3">
      <div class="card h-100">
        <div style="height: 180px; overflow: hidden">
          <img
            src="<%= entry.image_url %>"
            class="card-img-top"
            alt="Imagen de comida"
            style="width: 100%; height: 100%; object-fit: cover"
            onerror="this.onerror=null; this.src='/img/empty-plate.svg';"
          />
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <h5 class="card-title">Entrada #<%= entry.id %></h5>
            <span class="badge bg-primary"
              ><%= moment(entry.created_at).format('DD/MM/YYYY') %></span
            >
          </div>
          <p class="text-muted">
            <%= moment(entry.created_at).format('HH:mm') %>
          </p>
          <% if (entry.comments) { %>
          <p>
            <%= entry.comments.substring(0, 100) %><%= entry.comments.length >
            100 ? '...' : '' %>
          </p>
          <% } else { %>
          <p class="text-muted">Sin comentarios</p>
          <% } %>
        </div>
        <div class="card-footer bg-white d-flex justify-content-between">
          <a href="/doctor/entry/<%= entry.id %>" class="btn btn-sm btn-primary"
            >Ver Detalles</a
          >
          <small class="text-muted"
            ><%= entry.meal_type || 'No especificado' %></small
          >
        </div>
      </div>
    </div>
    <% }); %> <% } else { %>
    <div class="col-12 text-center py-4">
      <img
        src="/img/empty-plate.svg"
        alt="Plato vacío"
        style="width: 150px; margin-bottom: 1rem"
      />
      <h4 class="text-muted">No hay entradas en el historial</h4>
      <p class="text-muted">
        Este paciente aún no ha registrado ninguna comida.
      </p>
    </div>
    <% } %>
  </div>

  <!-- Paginación simplificada -->
  <% if (entries && entries.length > 0 && totalPages > 1) { %>
  <div class="row mt-3">
    <div class="col-12">
      <nav>
        <ul class="pagination justify-content-center">
          <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
            <a
              class="page-link"
              href="/doctor/patient/<%= patient.id %>/history?page=<%= currentPage - 1 %><%= filters ? '&date_from=' + filters.date_from + '&date_to=' + filters.date_to : '' %>"
              >Anterior</a
            >
          </li>

          <% for (let i = 1; i <= totalPages; i++) { %>
          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
            <a
              class="page-link"
              href="/doctor/patient/<%= patient.id %>/history?page=<%= i %><%= filters ? '&date_from=' + filters.date_from + '&date_to=' + filters.date_to : '' %>"
              ><%= i %></a
            >
          </li>
          <% } %>

          <li
            class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>"
          >
            <a
              class="page-link"
              href="/doctor/patient/<%= patient.id %>/history?page=<%= currentPage + 1 %><%= filters ? '&date_from=' + filters.date_from + '&date_to=' + filters.date_to : '' %>"
              >Siguiente</a
            >
          </li>
        </ul>
      </nav>
    </div>
  </div>
  <% } %>
</div>

<style>
  .card {
    transition: transform 0.2s;
  }
  .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
</style>
