<!-- Vista de Historial de Comidas -->
<div class="container mb-5">
  <div class="row mb-4">
    <div class="col-md-12 animate-on-scroll">
      <h1 class="mb-4 border-bottom pb-2">
        <i class="fas fa-history me-2"></i>Mi Historial de Comidas
      </h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/patient/dashboard">Dashboard</a></li>
          <li class="breadcrumb-item active">Historial</li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Filtros de búsqueda -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-filter me-2"></i>Filtrar Entradas
      </h5>
      <form action="/patient/history" method="GET" class="row g-3">
        <div class="col-md-4">
          <label for="date-from" class="form-label">Desde</label>
          <input type="date" class="form-control" id="date-from" name="date_from" 
                 value="<%= filters?.date_from || '' %>">
        </div>
        <div class="col-md-4">
          <label for="date-to" class="form-label">Hasta</label>
          <input type="date" class="form-control" id="date-to" name="date_to" 
                 value="<%= filters?.date_to || '' %>">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2">
            <i class="fas fa-search me-1"></i>Buscar
          </button>
          <a href="/patient/history" class="btn btn-outline-secondary">
            <i class="fas fa-redo me-1"></i>Reiniciar
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Entradas del historial -->
  <div class="row">
    <% if (foodEntries && foodEntries.length > 0) { %>
      <% foodEntries.forEach((entry, index) => { %>
        <div class="col-md-4 mb-4">
          <div class="card h-100 shadow-sm food-entry-card">
            <div class="card-img-container" style="height: 200px; overflow: hidden; position: relative; background-color: #f8f9fa;">
              <img 
                src="/img/empty-plate.svg"
                data-src="<%= entry.image_url || entry.image_data || '/img/empty-plate.svg' %>"
                class="card-img-top lazy-image" 
                alt="<%= entry.name || 'Foto de comida' %>" 
                loading="lazy"
                style="width: 100%; height: 100%; object-fit: cover;"
                onerror="this.onerror=null; this.src='/img/empty-plate.svg'; this.alt='Imagen no disponible'; this.style.padding = '20px';"
              >
              <div class="image-loading-spinner spinner-border text-primary" role="status" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </div>
            <div class="card-body">
              <h5 class="card-title"><%= entry.name || 'Comida sin nombre' %></h5>
              <div class="d-flex justify-content-between mb-2">
                <span class="badge bg-info"><%= entry.meal_type || 'Otro' %></span>
                <small class="text-muted">
                  <i class="fas fa-calendar-alt"></i> 
                  <%= new Date(entry.meal_date || entry.created_at).toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                  }) %>
                </small>
              </div>
              <p class="card-text">
                <% if (entry.description && entry.description.length > 50) { %>
                  <%= entry.description.substring(0, 50) %>...
                <% } else { %>
                  <%= entry.description || 'Sin descripción' %>
                <% } %>
              </p>
              <a href="/patient/entry/<%= entry.id %>" class="btn btn-sm btn-primary">Ver detalles</a>
            </div>
          </div>
        </div>
      <% }); %>
    <% } else { %>
      <div class="col-12 text-center py-5">
        <div class="card shadow-sm">
          <div class="card-body">
            <img src="/img/empty-plate.svg" alt="No hay entradas" style="max-width: 150px; margin-bottom: 20px;">
            <h3>Aún no has registrado ninguna comida</h3>
            <p class="text-muted">Cuando registres tus comidas, aparecerán aquí.</p>
            <a href="/patient/upload" class="btn btn-primary">
              <i class="fas fa-plus-circle"></i> Registrar comida
            </a>
          </div>
        </div>
      </div>
    <% } %>
  </div>

  <!-- Paginación -->
  <% if (pagination.totalPages > 1) { %>
    <div class="row">
      <div class="col-12">
        <nav aria-label="Paginación de historial">
          <ul class="pagination justify-content-center">
            <!-- Botón anterior -->
            <li class="page-item <%= pagination.currentPage <= 1 ? 'disabled' : '' %>">
              <a class="page-link" href="/patient/history?page=<%= pagination.currentPage - 1 %><%= filters.date_from ? '&date_from='+filters.date_from : '' %><%= filters.date_to ? '&date_to='+filters.date_to : '' %>" tabindex="-1" aria-disabled="<%= pagination.currentPage <= 1 %>">
                <i class="fas fa-chevron-left"></i> Anterior
              </a>
            </li>
            
            <!-- Páginas -->
            <% for(let i = 1; i <= pagination.totalPages; i++) { %>
              <li class="page-item <%= pagination.currentPage == i ? 'active' : '' %>">
                <a class="page-link" href="/patient/history?page=<%= i %><%= filters.date_from ? '&date_from='+filters.date_from : '' %><%= filters.date_to ? '&date_to='+filters.date_to : '' %>"><%= i %></a>
              </li>
            <% } %>
            
            <!-- Botón siguiente -->
            <li class="page-item <%= pagination.currentPage >= pagination.totalPages ? 'disabled' : '' %>">
              <a class="page-link" href="/patient/history?page=<%= pagination.currentPage + 1 %><%= filters.date_from ? '&date_from='+filters.date_from : '' %><%= filters.date_to ? '&date_to='+filters.date_to : '' %>" aria-disabled="<%= pagination.currentPage >= pagination.totalPages %>">
                Siguiente <i class="fas fa-chevron-right"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  <% } %>
</div>

<!-- Estilo para efecto de carga de imágenes -->
<style>
  .lazy-image {
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }
  .lazy-image.loaded {
    opacity: 1;
  }
  .image-loading-spinner {
    transition: opacity 0.3s ease-in-out;
  }
  .image-loading-spinner.hidden {
    opacity: 0;
  }
</style>

<!-- Script para implementar lazy loading avanzado y optimizado -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Control de concurrencia - limitar cargas simultáneas
    const MAX_CONCURRENT_LOADS = 3;
    let activeLoads = 0;
    const loadQueue = [];
    
    function processQueue() {
      if (loadQueue.length === 0 || activeLoads >= MAX_CONCURRENT_LOADS) return;
      
      // Tomar la siguiente imagen de la cola
      const nextImg = loadQueue.shift();
      activeLoads++;
      
      const img = nextImg.element;
      const src = nextImg.src;
      const spinner = nextImg.spinner;
      
      // Precargar la imagen
      const newImg = new Image();
      
      newImg.onload = function() {
        // Aplicar la imagen cuando se cargue
        setTimeout(() => {
          img.src = src;
          img.classList.add('loaded');
          if (spinner) spinner.style.display = 'none';
          
          // Liberar un espacio para otra carga
          activeLoads--;
          processQueue();
        }, 50);
      };
      
      newImg.onerror = function() {
        // Si hay error al cargar, cargar el placeholder
        img.src = '/img/empty-plate.svg';
        img.style.padding = '20px';
        img.classList.add('loaded');
        if (spinner) spinner.style.display = 'none';
        
        // Liberar un espacio para otra carga
        activeLoads--;
        processQueue();
      };
      
      // Iniciar la carga real
      setTimeout(() => {
        newImg.src = src;
      }, 20);
    }
    
    function queueImageLoad(imgElement, src, spinner) {
      // Añadir a la cola
      loadQueue.push({ element: imgElement, src: src, spinner: spinner });
      // Intentar procesar la cola
      processQueue();
    }
    
    // Implementación de IntersectionObserver para lazy loading
    if ('IntersectionObserver' in window) {
      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            const src = img.getAttribute('data-src');
            const spinner = img.parentNode.querySelector('.image-loading-spinner');
            
            // Solo cargar si src existe y es diferente al placeholder
            if (src && src !== '/img/empty-plate.svg') {
              queueImageLoad(img, src, spinner);
            } else {
              // Si es el placeholder, mostrarlo inmediatamente
              img.classList.add('loaded');
              if (spinner) spinner.style.display = 'none';
            }
            
            // Dejar de observar esta imagen
            observer.unobserve(img);
          }
        });
      }, {
        rootMargin: '150px 0px',
        threshold: 0.01
      });
      
      // Observar todas las imágenes con clase lazy-image
      document.querySelectorAll('img.lazy-image').forEach(img => {
        imageObserver.observe(img);
      });
    } else {
      // Fallback para navegadores que no soportan IntersectionObserver
      // Carga progresiva para no bloquear el navegador
      const lazyImages = Array.from(document.querySelectorAll('img.lazy-image'));
      let processed = 0;
      
      function processNextBatch() {
        const batchSize = 3;
        const end = Math.min(processed + batchSize, lazyImages.length);
        
        for (let i = processed; i < end; i++) {
          const img = lazyImages[i];
          const src = img.getAttribute('data-src');
          const spinner = img.parentNode.querySelector('.image-loading-spinner');
          
          if (src && src !== '/img/empty-plate.svg') {
            img.src = src;
          }
          
          img.classList.add('loaded');
          if (spinner) spinner.style.display = 'none';
        }
        
        processed = end;
        
        if (processed < lazyImages.length) {
          setTimeout(processNextBatch, 100);
        }
      }
      
      // Iniciar procesamiento por lotes
      if (lazyImages.length > 0) {
        processNextBatch();
      }
    }
  });
</script>
