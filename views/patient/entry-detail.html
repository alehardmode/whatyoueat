<!-- Detalle de Entrada de Comida -->
<div class="container mb-5">
<div class="card border-0 shadow">
<div class="row mb-4">
  <div class="col-md-12 animate-on-scroll">
    <h1 class="mb-4 border-bottom pb-2">
      <i class="fas fa-utensils me-2"></i>Detalle de Comida
    </h1>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/patient/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/patient/history">Historial</a></li>
        <li class="breadcrumb-item active">Detalle</li>
      </ol>
    </nav>
  </div>
</div>

<div class="row">
  <div class="col-md-10 mx-auto">
    <div class="card shadow-lg">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">
          <i class="fas fa-calendar-alt me-2"></i>
          <%= entry.name || 'Comida sin nombre' %> - <%= moment(entry.meal_date || entry.created_at).format('DD/MM/YYYY HH:mm') %>
        </h4>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Imagen -->
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-body text-center">
                <div class="image-container" style="min-height: 300px; display: flex; align-items: center; justify-content: center; position: relative;">
                  <!-- Placeholder mientras carga la imagen -->
                  <div class="image-loading-spinner spinner-border text-primary" role="status" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  <img 
                    src="/img/empty-plate.svg"
                    data-src="<%= entry.image_url || entry.image_data %>" 
                    class="img-fluid rounded shadow lazy-image" 
                    alt="<%= entry.name || 'Imagen de comida' %>" 
                    loading="lazy"
                    style="max-height: 400px; object-fit: contain; width: auto; max-width: 100%; opacity: 0; transition: opacity 0.3s ease-in-out;"
                    onerror="this.onerror=null; this.src='/img/empty-plate.svg'; this.alt='Imagen no disponible'; this.style.padding = '20px'; this.style.background = '#f8f9fa'; this.style.opacity = '1';">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Detalles -->
          <div class="col-md-6">
            <!-- Fecha y hora -->
            <div class="mb-4">
              <h5><i class="fas fa-clock me-2"></i>Información Temporal</h5>
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span><i class="fas fa-calendar me-2"></i>Fecha:</span>
                  <span class="badge bg-primary rounded-pill">
                    <%= moment(entry.meal_date || entry.created_at).format('DD/MM/YYYY') %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span><i class="fas fa-clock me-2"></i>Hora:</span>
                  <span class="badge bg-primary rounded-pill">
                    <%= moment(entry.meal_date || entry.created_at).format('HH:mm') %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span><i class="fas fa-utensils me-2"></i>Tipo de comida:</span>
                  <span class="badge bg-info rounded-pill">
                    <%= entry.meal_type || 'No especificado' %>
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span><i class="fas fa-history me-2"></i>Creado:</span>
                  <span class="badge bg-secondary rounded-pill">
                    <%= moment(entry.created_at).fromNow() %>
                  </span>
                </li>
              </ul>
            </div>
            
            <!-- Descripción -->
            <div class="mb-4">
              <h5><i class="fas fa-comment me-2"></i>Descripción</h5>
              <div class="card">
                <div class="card-body">
                  <% if (entry.description) { %>
                    <p class="card-text"><%= entry.description %></p>
                  <% } else { %>
                    <p class="text-muted">No hay descripción para esta entrada.</p>
                  <% } %>
                </div>
              </div>
            </div>
            
            <!-- Botones de acción -->
            <div class="d-flex justify-content-between mt-4">
              <a href="/patient/entry/<%= entry.id %>/edit" class="btn btn-primary">
                <i class="fas fa-edit me-1"></i>Editar
              </a>
              <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                <i class="fas fa-trash-alt me-1"></i>Eliminar
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="card-footer bg-white">
        <a href="/patient/history" class="btn btn-secondary">
          <i class="fas fa-arrow-left me-1"></i>Volver al Historial
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">¿Eliminar esta entrada?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que deseas eliminar esta entrada? Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a href="/patient/entry/<%= entry.id %>/delete" class="btn btn-danger">
          <i class="fas fa-trash-alt me-1"></i>Eliminar
        </a>
      </div>
    </div>
  </div>
</div>

</div>
</div>

<!-- Script para implementar lazy loading de la imagen de detalle -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const lazyImage = document.querySelector('.lazy-image');
    if (lazyImage) {
      const src = lazyImage.getAttribute('data-src');
      const spinner = document.querySelector('.image-loading-spinner');
      
      // Si tenemos el atributo data-src y es diferente del placeholder
      if (src && src !== '/img/empty-plate.svg') {
        // Crear una nueva imagen para precargar
        const newImg = new Image();
        
        newImg.onload = function() {
          // Cuando la imagen se carga completamente
          lazyImage.src = src;
          lazyImage.style.opacity = '1';
          if (spinner) spinner.style.display = 'none'; // Más eficiente que cambiar opacity
        };
        
        newImg.onerror = function() {
          // Si hay error al cargar la imagen
          if (spinner) spinner.style.display = 'none';
          // Empty-plate ya está cargado, solo ajustamos el estilo
          lazyImage.style.padding = '20px';
          lazyImage.style.background = '#f8f9fa';
          lazyImage.style.opacity = '1';
        };
        
        // Iniciar carga de la imagen real
        newImg.src = src;
      } else {
        // Si no hay data-src o es igual al placeholder, sólo mostramos el placeholder
        if (spinner) spinner.style.display = 'none';
        lazyImage.style.opacity = '1';
      }
    }
  });
</script>